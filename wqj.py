import streamlit as st
import pandas as pd
import numpy as np

# --------------------------
# é¡µé¢é…ç½®ï¼ˆå®½å±å¸ƒå±€ï¼Œç¾è§‚å›¾æ ‡ï¼‰
# --------------------------
st.set_page_config(
    page_title="å—å®å…¬å›­æ•°æ®ä»ªè¡¨ç›˜",
    page_icon="ğŸŒ³",
    layout="wide",
    initial_sidebar_state="expanded"
)

# --------------------------
# æ„é€ æ ¸å¿ƒæ•°æ®ï¼ˆ6ä¸ªå…¬å›­ï¼Œå®Œæ•´12ä¸ªæœˆæ•°æ®ï¼‰
# --------------------------
# 1. å…¬å›­åŸºç¡€ä¿¡æ¯ï¼ˆå«ç²¾å‡†åœ°ç†åæ ‡ï¼‰
park_info = pd.DataFrame({
    "å…¬å›­åç§°": [
        "é’ç§€å±±é£æ™¯åŒº",
        "å—æ¹–å…¬å›­",
        "å—å®å¸‚äººæ°‘å…¬å›­",
        "ç‹®å±±å…¬å›­",
        "çŸ³é—¨æ£®æ—å…¬å›­",
        "è‰¯å‡¤æ±Ÿå›½å®¶æ£®æ—å…¬å›­"
    ],
    "åœ°å€": [
        "é’ç§€åŒºå‡¤å²­å—è·¯6å·",
        "é’ç§€åŒºåŒæ‹¥è·¯1å·",
        "å…´å®åŒºäººæ°‘ä¸œè·¯1å·",
        "å…´å®åŒºé‚•æ­¦è·¯4å·",
        "é’ç§€åŒºæ°‘æ—å¤§é“118å·",
        "æ±Ÿå—åŒºå‹è°Šè·¯78å·"
    ],
    "å åœ°é¢ç§¯(å…¬é¡·)": [437.6, 191.9, 50.1, 80.2, 160.0, 486.7],
    "å¹´æ¸¸å®¢é‡(ä¸‡äººæ¬¡)": [650, 820, 480, 320, 390, 210],
    "æ¸¸å®¢è¯„åˆ†(5åˆ†åˆ¶)": [4.8, 4.7, 4.6, 4.5, 4.4, 4.3],
    "çº¬åº¦": [22.8167, 22.8469, 22.8728, 22.8958, 22.8397, 22.6522],
    "ç»åº¦": [108.3572, 108.3267, 108.3225, 108.3017, 108.3508, 108.3689]
})

# 2. 12ä¸ªæœˆä»·æ ¼èµ°åŠ¿æ•°æ®ï¼ˆç¡®ä¿1-12æœˆé¡ºåºï¼‰
months = ["1æœˆ", "2æœˆ", "3æœˆ", "4æœˆ", "5æœˆ", "6æœˆ", "7æœˆ", "8æœˆ", "9æœˆ", "10æœˆ", "11æœˆ", "12æœˆ"]
price_data = pd.DataFrame({
    "æœˆä»½": months,
    "é’ç§€å±±é£æ™¯åŒº": [30, 30, 20, 20, 30, 20, 20, 20, 20, 30, 20, 20],  # æ”¶è´¹å…¬å›­
    "å—æ¹–å…¬å›­": [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],                # å…è´¹å…¬å›­
    "å—å®å¸‚äººæ°‘å…¬å›­": [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],          # å…è´¹å…¬å›­
    "ç‹®å±±å…¬å›­": [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],                # å…è´¹å…¬å›­
    "çŸ³é—¨æ£®æ—å…¬å›­": [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],            # å…è´¹å…¬å›­
    "è‰¯å‡¤æ±Ÿå›½å®¶æ£®æ—å…¬å›­": [20, 20, 15, 15, 20, 15, 15, 15, 15, 20, 15, 15]  # æ”¶è´¹å…¬å›­
}).set_index("æœˆä»½")

# 3. æœˆåº¦æ¸¸å®¢é‡æ•°æ®ï¼ˆç”¨äºé¢ç§¯å›¾ï¼‰
monthly_visitor_data = pd.DataFrame({
    "æœˆä»½": months,
    "é’ç§€å±±é£æ™¯åŒº": [55, 78, 52, 45, 60, 48, 42, 40, 38, 85, 50, 45],
    "å—æ¹–å…¬å›­": [68, 85, 72, 65, 75, 62, 58, 55, 60, 90, 70, 65],
    "å—å®å¸‚äººæ°‘å…¬å›­": [40, 55, 42, 38, 45, 35, 32, 30, 28, 60, 42, 38],
    "ç‹®å±±å…¬å›­": [28, 35, 30, 25, 32, 26, 24, 22, 20, 40, 28, 25],
    "çŸ³é—¨æ£®æ—å…¬å›­": [32, 40, 35, 30, 38, 32, 29, 27, 25, 45, 35, 30],
    "è‰¯å‡¤æ±Ÿå›½å®¶æ£®æ—å…¬å›­": [18, 25, 20, 16, 22, 18, 15, 14, 12, 30, 19, 16]
}).set_index("æœˆä»½")

# --------------------------
# ä¾§è¾¹æ ï¼ˆå…¬å›­ç­›é€‰åŠŸèƒ½ï¼‰
# --------------------------
st.sidebar.header("ğŸŒ³ å—å®å…¬å›­æ•°æ®ç­›é€‰")
selected_parks = st.sidebar.multiselect(
    "é€‰æ‹©è¦æŸ¥çœ‹çš„å…¬å›­",
    options=park_info["å…¬å›­åç§°"].unique(),
    default=park_info["å…¬å›­åç§°"].unique()  # é»˜è®¤é€‰ä¸­æ‰€æœ‰å…¬å›­
)

# æ•°æ®ç­›é€‰ï¼ˆå¢åŠ å¥å£®æ€§æ ¡éªŒï¼Œé¿å…æŠ¥é”™ï¼‰
valid_parks = [park for park in selected_parks if park in price_data.columns]
filtered_park_info = park_info[park_info["å…¬å›­åç§°"].isin(valid_parks)]
filtered_price_data = price_data[valid_parks]
filtered_monthly_visitor = monthly_visitor_data[valid_parks]

# æ— æ•ˆé€‰æ‹©æç¤ºï¼ˆå‹å¥½æç¤ºç”¨æˆ·ï¼‰
invalid_parks = set(selected_parks) - set(valid_parks)
if invalid_parks:
    st.sidebar.warning(f"ä»¥ä¸‹å…¬å›­æ— ä»·æ ¼æ•°æ®ï¼Œå·²è‡ªåŠ¨è¿‡æ»¤ï¼š{', '.join(invalid_parks)}")

# --------------------------
# ä¸»é¡µé¢å†…å®¹ï¼ˆå®Œæ•´å¯è§†åŒ–å±•ç¤ºï¼‰
# --------------------------
st.title("ğŸŒ³ å—å®å…¬å›­æ•°æ®å¯è§†åŒ–ä»ªè¡¨ç›˜")
st.divider()

# 1. å…¬å›­åŸºç¡€ä¿¡æ¯è¡¨æ ¼
st.subheader("ä¸€ã€å…¬å›­åŸºç¡€ä¿¡æ¯")
st.dataframe(
    filtered_park_info.drop(["çº¬åº¦", "ç»åº¦"], axis=1),
    use_container_width=True,
    hide_index=True
)

st.divider()

# 2. ä¼˜åŒ–åçš„ä»·æ ¼èµ°åŠ¿æŠ˜çº¿å›¾ï¼ˆæ ¸å¿ƒä¼˜åŒ–ï¼‰
st.subheader("äºŒã€å…¬å›­12ä¸ªæœˆé—¨ç¥¨ä»·æ ¼èµ°åŠ¿")
# å¼ºåˆ¶æŒ‰1-12æœˆæ’åºï¼Œè§£å†³æœˆä»½æ··ä¹±é—®é¢˜
filtered_price_data = filtered_price_data.reindex(months)
st.caption("æ³¨ï¼šçº¢è‰²/æ©™è‰²ç²—çº¿ä¸ºæ”¶è´¹å…¬å›­ï¼Œæµ…è‰²ç»†çº¿ä¸ºå…è´¹å…¬å›­ï¼ˆ0å…ƒï¼‰ï¼Œé¼ æ ‡æ‚¬åœå¯æŸ¥çœ‹å…·ä½“ä»·æ ¼")

# è‡ªå®šä¹‰æ ·å¼æ˜ å°„ï¼ˆåŒºåˆ†æ”¶è´¹/å…è´¹å…¬å›­ï¼‰
park_styles = {
    "é’ç§€å±±é£æ™¯åŒº": {"color": "#E53E3E", "line_width": 4},        # æ”¶è´¹-å¤§çº¢ç²—çº¿
    "è‰¯å‡¤æ±Ÿå›½å®¶æ£®æ—å…¬å›­": {"color": "#DD6B20", "line_width": 4},  # æ”¶è´¹-æ·±æ©™ç²—çº¿
    "å—æ¹–å…¬å›­": {"color": "#38A16980", "line_width": 2},          # å…è´¹-æµ…ç»¿ç»†çº¿ï¼ˆ80ä¸ºé€æ˜åº¦ï¼‰
    "å—å®å¸‚äººæ°‘å…¬å›­": {"color": "#3182CE80", "line_width": 2},      # å…è´¹-æµ…è“ç»†çº¿
    "ç‹®å±±å…¬å›­": {"color": "#805AD580", "line_width": 2},          # å…è´¹-æµ…ç´«ç»†çº¿
    "çŸ³é—¨æ£®æ—å…¬å›­": {"color": "#D69E2E80", "line_width": 2}        # å…è´¹-æµ…é»„ç»†çº¿
}

# æå–é€‰ä¸­å…¬å›­å¯¹åº”çš„é¢œè‰²åˆ—è¡¨
selected_colors = [park_styles[park]["color"] for park in valid_parks]

# æŠ˜çº¿å›¾å¸ƒå±€ï¼ˆå·¦å³åˆ†æ ï¼Œç¾è§‚æ¸…æ™°ï¼‰
col1, col2 = st.columns([8, 2])
with col1:
    # ç»˜åˆ¶åŸç”ŸæŠ˜çº¿å›¾ï¼Œå¢å¤§é«˜åº¦é¿å…æ‹¥æŒ¤
    st.line_chart(
        filtered_price_data,
        use_container_width=True,
        color=selected_colors,
        y_label="é—¨ç¥¨ä»·æ ¼ï¼ˆå…ƒï¼‰",
        height=400
    )
    # æ³¨å…¥JSè°ƒæ•´çº¿æ¡å®½åº¦ï¼ˆåŸç”Ÿå›¾è¡¨é—´æ¥å®ç°çº¿å®½åŒºåˆ†ï¼‰
    st.markdown(f"""
        <script>
            const lineElements = document.querySelectorAll('.stLineChart svg g path');
            const parkList = {valid_parks};
            const styleMap = {park_styles};
            parkList.forEach((park, index) => {{
                if (lineElements[index]) {{
                    lineElements[index].setAttribute('stroke-width', styleMap[park].line_width);
                }}
            }});
        </script>
    """, unsafe_allow_html=True)

with col2:
    # ä»·æ ¼è¯´æ˜ä¾§è¾¹æ 
    st.markdown("### ğŸ« ä»·æ ¼æ˜ç»†")
    st.markdown("- **é’ç§€å±±é£æ™¯åŒº**ï¼šèŠ‚å‡æ—¥30å…ƒï¼Œå¹³æ—¥20å…ƒ")
    st.markdown("- **è‰¯å‡¤æ±Ÿå›½å®¶æ£®æ—å…¬å›­**ï¼šèŠ‚å‡æ—¥20å…ƒï¼Œå¹³æ—¥15å…ƒ")
    st.markdown("- **å…¶ä½™å…¬å›­**ï¼šå…¨å¹´å…è´¹å¼€æ”¾")
    st.markdown("### ğŸ“Š æ“ä½œæç¤º")
    st.markdown("- é¼ æ ‡æ‚¬åœæŸ¥çœ‹ç²¾å‡†ä»·æ ¼")
    st.markdown("- ç‚¹å‡»å›¾ä¾‹éšè—/æ˜¾ç¤ºå…¬å›­")

st.divider()

# 3. æŸ±çŠ¶å›¾+é¢ç§¯å›¾ï¼ˆåŒæ å¸ƒå±€ï¼‰
col3, col4 = st.columns(2)

# æŸ±çŠ¶å›¾ï¼šå¹´æ¸¸å®¢é‡å¯¹æ¯”
with col3:
    st.subheader("ä¸‰ã€å…¬å›­å¹´æ¸¸å®¢é‡å¯¹æ¯”")
    bar_data = filtered_park_info.set_index("å…¬å›­åç§°")["å¹´æ¸¸å®¢é‡(ä¸‡äººæ¬¡)"]
    st.bar_chart(
        bar_data,
        use_container_width=True,
        color="#2E8B57",
        y_label="å¹´æ¸¸å®¢é‡ï¼ˆä¸‡äººæ¬¡ï¼‰",
        height=400
    )

# é¢ç§¯å›¾ï¼šæœˆåº¦æ¸¸å®¢é‡è¶‹åŠ¿ï¼ˆä¼˜åŒ–é‡å é—®é¢˜ï¼‰
with col4:
    st.subheader("å››ã€å…¬å›­æœˆåº¦æ¸¸å®¢é‡è¶‹åŠ¿")
    # å¼ºåˆ¶æœˆä»½æ’åºï¼ŒåŠé€æ˜è‰²é¿å…é‡å 
    filtered_monthly_visitor = filtered_monthly_visitor.reindex(months)
    area_colors = [park_styles[park]["color"] for park in valid_parks]
    st.area_chart(
        filtered_monthly_visitor,
        use_container_width=True,
        color=area_colors,
        y_label="æœˆåº¦æ¸¸å®¢é‡ï¼ˆä¸‡äººæ¬¡ï¼‰",
        height=400
    )

st.divider()

# 4. ä¿®å¤åçš„å…¬å›­åœ°ç†ä½ç½®åˆ†å¸ƒï¼ˆå…¼å®¹æ‰€æœ‰Streamlitç‰ˆæœ¬ï¼‰
st.subheader("äº”ã€å…¬å›­åœ°ç†ä½ç½®åˆ†å¸ƒ")
st.caption("æ³¨ï¼šæ ‡è®°ç‚¹ä¸ºå…¬å›­å®é™…åœ°ç†åæ ‡ï¼Œå¯æ”¾å¤§/ç¼©å°ã€æ‹–æ‹½æŸ¥çœ‹è¯¦æƒ…")

# ç§»é™¤ä¸å…¼å®¹å‚æ•°ï¼Œç¡®ä¿åœ°å›¾æ­£å¸¸æ¸²æŸ“
st.map(
    filtered_park_info,
    latitude="çº¬åº¦",
    longitude="ç»åº¦"
)

# è¡¥å……å…¬å›­åœ°å€è¯¦æƒ…
st.markdown("### ğŸ“Œ å…¬å›­åœ°å€è¯¦æƒ…")
location_detail = filtered_park_info[["å…¬å›­åç§°", "åœ°å€"]].set_index("å…¬å›­åç§°")
st.dataframe(location_detail, use_container_width=True)

# é¡µè„šä¿¡æ¯
st.divider()
st.markdown("---")
st.markdown("Â© 2025 å—å®å…¬å›­æ•°æ®å¯è§†åŒ–å¹³å° | æ•°æ®ä¸ºæ¨¡æ‹Ÿæ•´ç†ï¼Œä»…ä¾›å±•ç¤ºä½¿ç”¨")
